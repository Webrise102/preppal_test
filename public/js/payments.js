let shippingZip,shippingCity,shippingAddress,firstName,lastName,shippingPhone,houseNumber,orderEmail,shippingCountry;-1!==navigator.userAgent.indexOf("Edg")&&(document.getElementById("browser").innerHTML="If you are using microsoft edge, the debit/credit card payment method may work incorrectly",document.getElementById("browser").style.paddingBottom="10px",document.getElementById("browser").style.marginBottom="1rem");let isTrue=!1,deliveryOption="normal";cartData.forEach((e=>{isTrue="fast"!==e.productDelivery})),isTrue?(document.getElementById("phoneBlock").style.display="none",document.getElementById("phoneBlock").disabled=!0):(document.getElementById("phoneBlock").style.display="block",document.getElementById("phoneBlock").disabled=!1);const errorMessage=document.querySelector(".error-message2"),someDataPrice=cartData[0].productPrice,newDataPrice=someDataPrice.replace("$","").replace(",",".");function updatePayPal(){const e="capture";var t;(t="https://www.paypal.com/sdk/js?client-id=AXh5j1fggZvIaes8IhbEnM57pWoDNedqn5dEJ7W0RueFaYBYrkb4HShgFeUbBXTcQXCN0jZhfJ053R0E&enable-funding=venmo&currency=USD&intent="+e,new Promise((function(e,o){var r=document.createElement("script");r.src=t,r.onload=function(){e()},r.onerror=function(){o("Error loading script.")},document.head.appendChild(r)}))).then((()=>{let t=paypal.Buttons({onClick:async function(){if(200===(await fetch("/check-connection",{method:"POST"})).status){const e=await new Promise((e=>{checkAll((t=>{e(t)}),deliveryOption)}));return console.log(e),!!e}return window.scrollTo({top:0,behavior:"instant"}),document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box2").style.display="block",document.querySelector(".error-box2").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",!1},createOrder:function(t,o){return fetch("/create_order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({intent:e})}).then((e=>e.json())).then((e=>e.id))},onApprove:function(o,r){let n=o.orderID;return fetch("https://preppal-test.onrender.com/complete_order",{method:"post",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify({intent:e,order_id:n})}).then((e=>e.json())).then((e=>{storeOrder(),t.close()})).catch((e=>{console.log(e)}))},onError:function(e){console.log(e);switch(/"name":"(.*?)"/.exec(e)[1]){case"BUYER_CANCEL":errorMessage.innerHTML="Transaction cancelled by buyer",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"INSTRUMENT_DECLINED":errorMessage.innerHTML="Payment method was declined",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"PAYER_ACTION_REQUIRED":errorMessage.innerHTML="Buyer action required to continue",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"PAYMENT_FAILURE":errorMessage.innerHTML="Payment failed, please try again",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"INTERNAL_SERVICE_ERROR":errorMessage.innerHTML="Internal service error, try again later",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"NOT_CONFIGURED":errorMessage.innerHTML="PayPal buttons not properly configured",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"INVALID_CONFIGURATION":errorMessage.innerHTML="Invalid configuration provided",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"UNSUPPORTED_BROWSER":errorMessage.innerHTML="This browser is not supported by PayPal",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"BUYER_ACCOUNT_ERROR":errorMessage.innerHTML="Problem with buyer PayPal account",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"DEPOSIT_FAILED":errorMessage.innerHTML="Failed to charge buyer account",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;case"UNPROCESSABLE_ENTITY":errorMessage.innerHTML="Check if your cart isn`t empty or try reloading page",document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.querySelector(".error-box1").style.display="block",document.querySelector(".error-box1").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden",window.scrollTo({top:0,behavior:"instant"});break;default:errorMessage.innerHTML="Unknown error occurred"}}}).render("#payment_options").then((function(){document.getElementById("loader").style.display="none",document.getElementById("checkoutForm").style.display="block"}))}))}updatePayPal(totalsum);const countryMapping={Belgium:"BE","Czech Republic":"CZ",Denmark:"DK",Finland:"FI",France:"FR",Germany:"DE",Ireland:"IE",Italy:"IT",Luxembourg:"LU",Netherlands:"NL",Poland:"PL",Spain:"ES",Sweden:"SE","United Kingdom":"GB","United States":"US",Canada:"CA","New Zealand":"NZ"},selectElement=document.querySelector(".country-select"),productsess=[],deliveryBlock=document.querySelector(".radio-inputs");for(const e in cartData){const t={delivery:deliveryOption,name:cartData[e].productTitle,quantity:cartData[e].productAmount,color:cartData[e].productColor};productsess.push(t)}console.log(productsess);const plugMapping={"United States":"US",Canada:"US","New Zealand":"AU","United Kingdom":"UK",Ireland:"UK",France:"EU",Germany:"EU"},videoIds={US_white:"1636420804961382400",US_black:"1636420805179486208",AU_white:"1636420805124960256",AU_black:"1636420805347258368",UK_white:"1636420805070434304",UK_black:"1636420805288538112",EU_white:"1636420805015908352",EU_black:"1636420805234012160"};let vid,Date1,Date2;async function checkAll(e,t){let o=!1;o="DHL Official"===t;const r={name:!1,email:!1,phone:!1,address:!1,house:!1,zip:!1};shippingZip=document.getElementById("zip").value,shippingCity=document.getElementById("city").value,shippingAddress=document.getElementById("address").value,firstName=document.getElementById("firstName").value,lastName=document.getElementById("lastName").value,shippingPhone=document.getElementById("phone").value,houseNumber=document.getElementById("house").value,orderEmail=document.getElementById("email").value,shippingCountry=document.querySelector(".form-select").value,""===firstName||""===lastName?(document.querySelector(".nameError").innerHTML="Please fill in all name fields.",r.name=!1):(r.name=!0,document.querySelector(".nameError").innerHTML=""),""===houseNumber?(document.querySelector(".houseError").innerHTML="Please fill in the house number field.",r.house=!1):(r.house=!0,document.querySelector(".houseError").innerHTML=""),/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(orderEmail)?(r.email=!0,document.querySelector(".errorEmail").innerHTML=""):(document.querySelector(".errorEmail").innerHTML="Invalid Email Address",r.email=!1),function(e,t){let o;const n=/^\d{5,}$/;switch(t){case"Belgium":case"Denmark":case"Luxembourg":case"New Zealand":o=/^\d{4}$/;break;case"Czech Republic":case"Finland":case"France":case"Germany":case"Italy":case"Spain":case"Sweden":o=/^\d{5}$/;break;case"Ireland":o=/^[A-Za-z\d]{3}\s?[A-Za-z\d]{4}$/;break;case"Netherlands":o=/^\d{4}\s?[A-Za-z]{2}$/;break;case"Poland":o=/^\d{2}-\d{3}$/;break;case"United Kingdom":o=/^[A-Za-z]{1,2}\d{1,2}\s?\d[A-Za-z]{2}$/;break;case"United States":o=/^\d{5}(-\d{4})?$/;break;case"Canada":o=/^[A-Za-z]\d[A-Za-z]\s?\d[A-Za-z]\d$/;break;default:o=n}!0===o.test(e)?(r.zip=!0,document.querySelector(".errorZip").innerHTML=""):document.querySelector(".errorZip").innerHTML="Incorrect ZIP"}(shippingZip,shippingCountry),!1===o?r.phone=!0:!0===o&&(/(?:(?:\+?1\s*(?:[.-]\s*)?)?(?:(\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]‌​)\s*)|([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\s*(?:[.-]\s*)?)([2-9]1[02-9]‌​|[2-9][02-9]1|[2-9][02-9]{2})\s*(?:[.-]\s*)?([0-9]{4})\s*(?:\s*(?:#|x\.?|ext\.?|extension)\s*(\d+)\s*)?$/i.test(shippingPhone)?(r.phone=!0,document.querySelector(".errorPhone").innerHTML=""):(document.querySelector(".errorPhone").innerHTML="Phone Is Incorrect",r.phone=!1)),function(e){const t={address:shippingAddress,city:shippingCity,zip:shippingZip,country:shippingCountry};!0===r.zip&&""!==shippingAddress&&""!==shippingCity?(document.querySelector(".errorAddress").innerHTML="",document.querySelector(".cityError").innerHTML="",fetch("/check-address",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:t.address,city:t.city,country:t.country})}).then((e=>e.json())).then((o=>{const n=o.data;n.results.length>0?n.results.forEach((e=>{if(e.postcode===t.zip&&e.country===t.country)if(r.address=!0,e.city!==shippingCity){document.querySelector(".hint").innerHTML=`Did you mean <span class="hint_city" style="font-style: italic;cursor: pointer;">${e.city}</span>?`;const t=document.getElementById("city");document.querySelector(".hint_city").addEventListener("click",(function(){const e=document.querySelector(".hint_city").innerHTML;t.value=e}))}else document.querySelector(".hint").innerHTML="";else console.log("country problems"),e.country!==t.country?document.querySelector(".countryError").innerHTML="Incorrect country":document.querySelector(".countryError").innerHTML="",e.postcode!==t.zip?document.querySelector(".errorZip").innerHTML="Postal code doesnt match":document.querySelector(".errorZip").innerHTML=""})):(r.address=!1,document.querySelector(".deliveryFormError").innerHTML="No such an adress found, recheck country/address",document.querySelector(".deliveryFormError").style.color="red"),console.log(r),e()})).catch((t=>{r.address=!1,console.log("Error:"),console.log(t),e()}))):(r.address=!1,document.querySelector(".errorAddress").innerHTML=""===shippingAddress?"Address can`t be empty":"",document.querySelector(".cityError").innerHTML=""===shippingCity?"City can`t be empty":"",e())}((()=>{const t=Object.values(r).every((e=>!0===e));e(t)}))}function storeOrder(){const e=document.getElementById("province").value,t=document.getElementById("address2").value,o=Math.floor(1e8*Math.random()+1e8),r=[];for(const e in cartData){const t={delivery:deliveryOption,name:cartData[e].productTitle,quantity:cartData[e].productAmount,color:cartData[e].productColor};r.push(t)}const n=r.map((e=>`${e.delivery}, ${e.color} ${e.name} * ${e.quantity}`)).join(", "),a={OrderDate:new Date,OrderZip:`${shippingZip}`,OrderCity:`${shippingCity}`,OrderAddress:`${shippingAddress}`,LastName:`${firstName}`,FirstName:` ${lastName}`,OrderPhone:`${shippingPhone}`,OrderEmail:`${orderEmail}`,OrderProvince:`${e}`,OrderAddress2:`${t}`,Total:Number(totalsum.toFixed(2)),OrderStatus:"New",OrderTrackingNumber:"",OrderProducts:n,OrderNumber:o,OrderCountry:shippingCountry};fetch("/create-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),fetch("/send-success",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({firstName:firstName,lastName:lastName,address:shippingCity+" "+shippingAddress+" "+shippingZip,total:totalsum,orderDate1:Date1,orderDate2:Date2,orderNumber:o,email:orderEmail})}),localStorage.removeItem("cart"),window.scrollTo({top:0,behavior:"instant"}),document.getElementById("container").style.display="block",document.getElementById("container").style.boxShadow="0px 0px 500px 500px rgba(0,0,0,0.89)",document.getElementById("success-box").style.display="block",document.getElementById("success-box").style.boxShadow="0px 0px 50px 5000px rgba(0,0,0,0.89)",document.body.style.overflow="hidden"}function showLoader(){document.querySelector("form").style.display="none";document.getElementById("loader").style.display="block"}function hideLoader(){document.querySelector("form").style.display="block";document.getElementById("loader").style.display="none"}selectElement.addEventListener("change",(function(){deliveryBlock.innerHTML="";const e=this.options[this.selectedIndex].text,t=countryMapping[e];let o,r=plugMapping[e];void 0===r&&(r="EU"),cartData.forEach((e=>{o=e.productAmount,vid="white"===e.productColor?videoIds[`${r}_white`]:videoIds[`${r}_black`]})),fetch("/delivery-calculate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({end:t,products:[{quantity:o,vid:vid}]})}).then((e=>e.json())).then((e=>{e.sort(((e,t)=>{const o=["CJPacket Ordinary","CJPacket Fast Ordinary","DHL Official"];return o.indexOf(e.name)-o.indexOf(t.name)})),e.forEach((e=>{"CJPacket Ordinary"===e.name&&(e.price>=23?e.price-=23:e.price=0),"CJPacket Fast Ordinary"===e.name&&(e.price=Math.max(5,e.price-23)),"DHL Official"===e.name&&(e.price=Math.max(10,e.price-23),e.price=Math.round(2*e.price)/2)})),e.forEach((e=>{let t;if("CJPacket Ordinary"===e.name){const o=e.time,[r,n]=o.split("-"),a=parseInt(r),c=parseInt(n);t=`Default Shipping (${a}-${c-1})`,Date1=a,Date2=c}else if("CJPacket Fast Ordinary"===e.name){t=`Fast Shipping (${e.time})`;const o=e.time,[r,n]=o.split("-"),a=parseInt(r),c=parseInt(n);Date1=a,Date2=c}else if("DHL Official"===e.name){const o=e.time;t=`Express Shipping (${e.time})`;const[r,n]=o.split("-"),a=parseInt(r),c=parseInt(n);Date1=a,Date2=c}const o=document.createElement("label");"CJPacket Ordinary"===e.name?o.innerHTML=`              \n          <input class="radio-input" type="radio" name="engine" checked>\n            <span class="radio-tile">\n              <span class="radio-label" data-value="${e.name}">${t}</span>\n              <span class="radio-label">$${e.price.toFixed(2)}</span>\n  \n            </span>\n        `:o.innerHTML=`              \n          <input class="radio-input" type="radio" name="engine">\n            <span class="radio-tile">\n              <span class="radio-label" data-value="${e.name}">${t}</span>\n              <span class="radio-label">$${e.price.toFixed(2)}</span>\n  \n            </span>\n        `,deliveryBlock.appendChild(o)}));const t=document.querySelectorAll(".radio-input");t.forEach((e=>{e.addEventListener("change",(()=>{const t=e.nextElementSibling.querySelector(".radio-label:last-child"),o=Number(t.textContent.replace("$","")),r=e.nextElementSibling.querySelector(".radio-label:first-child").getAttribute("data-value");document.getElementById("phoneBlock").style.display="DHL Official"===r?"block":"none";const n=Number(sum);deliveryOption=`${r}`,totalsum=n+o,totalElement.innerText=`$${totalsum.toFixed(2)}`;const a=document.querySelector(".checkout_shipping_price"),c=e.nextElementSibling.querySelector(".radio-label:first-child").textContent;document.querySelector(".delvieryClass").innerHTML=`${c}`,a.innerText=`$${o.toFixed(2)}`,fetch("/check-price",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({price:o,name:r})}).then((e=>{}))}))}));const o=new Event("change");t[0].dispatchEvent(o)}))})),window.addEventListener("load",(()=>{selectElement.dispatchEvent(new Event("change"))}));
